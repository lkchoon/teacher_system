const mysql = require('mysql');
const express = require("express");
const bodyParser = require('body-parser')
StudentAcceptedNotificationResponse = require("./studentAcceptedNotificationResponse.js");
StudentListResponse = require("./studentListResponse.js");
ErrorResponse = require("./errorResponse.js");
const con = mysql.createConnection({
    host: "localhost",
    user: "root",
    password: "root",
    database: "teacher_system"
});

const app = express();
const port = 8000;
app.listen(port, () => {
    console.log('We are live on ' + port);
});

app.use(
    bodyParser.urlencoded({
        extended: true
    })
);

app.use(bodyParser.json());

app.get("/api/commonstudents", (req, res, next) => {
    let teacher = Array.from(req.query.teacher);
    let inlist = '';
    for (let i = 0; i < teacher.length; i++) {
        inlist += '?,';
    }
    inlist = inlist.substring(0, inlist.length - 1);
    let sql = `select s.email as student_email from lesson l` +
        ` straight_join teacher t on l.teacher_email = t.email ` +
        ` straight_join student s on l.student_email = s.email ` +
        ` and l.teacher_email IN (` + inlist + `) `;

    let response = null;
    con.query(sql, teacher, (error, results, fields) => {
        if (error) {
			res.json(new ErrorResponse(error.message)).status(500).send();
        } else {
            let studentSet = new Set();
            results.forEach(function(item) {
                studentSet.add(item.student_email);
            });
			res.json(new StudentListResponse(Array.from(studentSet))).send();
        }
    });
});
app.post("/api/suspend", (req, res, next) => {
    let sql = `update student set status = 1 where email = ?`;
    con.query(sql, req.body.student, (error, results, fields) => {
        if (error) {
            response = new ErrorResponse(error.message);
        }else{
          res.status(204).send();
		}
    });
});
app.post("/api/register", (req, res, next) => {
    let sql = "insert into lesson (teacher_email,student_email) values ?";
    let teacher_email = req.body.teacher;
    let students = req.body.students;
    let values = [];
    for (let i = 0; i < students.length; i++) {
        let item = [];
        item.push(teacher_email);
        item.push(students[i].replace(/'/g, ""));
        values.push(item);
    };
    con.query(sql, [values], (error, results, fields) => {
        if (error) {
            return console.error(error.message);
        }
        res.status(204).send();
    });
});
app.post("/api/retrievefornotifications", (req, res, next) => {
    let sql = `select student_email from lesson straight_join student s on student_email = (select s.email where status = 0) where teacher_email = ?`;
    con.query(sql, teacher, (error, results, fields) => {
        if (error) {
            return console.error(error.message);
        }
        let studentAcceptedNotificationSet = new Set();
        results.forEach(function(item) {
            studentAcceptedNotificationSet.add(item.student_email);
        });
        let response = new StudentAcceptedNotificationResponse(Array.from(studentAcceptedNotificationSet));
        res.json(response);
    });
});